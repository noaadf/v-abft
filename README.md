# 浮点数校验误差门限设计说明书
**Design Specification for Floating-Point Error Bounding in GEMM**

**中文** | [English](README_EN.md)

| 文档版本 | 1.2  |  |  |
| :--- | :--- | :--- | :--- |
| **适用场景** | 大模型训练/推理 GEMM 算子校验 | **硬件目标** | 昇腾910B |

---

## 1. 背景与设计目标 (Background & Obnectives)

### 1.1 问题定义
在深度学习（尤其是 LLM）的大规模矩阵乘法（GEMM）中，硬件软错误（Soft Errors/Bit-flips）与浮点运算固有的舍入误差（Round-off Error）难以区分。随着对模型规模和训推速度的需求不断增长，低精度浮点数（如 BF16、FP8）和大规模矩阵（如 $K > 8192$）的应用日益普遍，传统的**门限校验算法**面临严峻挑战。
*   **挑战**：
    *   随着精度降低（BF16/FP8）和矩阵规模增大（$K > 8192$），累加产生的舍入误差幅度可能超过单粒子翻转（SEU）引起的偏差，导致传统固定门限校验失效（漏检或误报）。
    *   在低精度下，随着计算深度增加，累加误差会显著放大，仅仅依靠C矩阵的门限检测逐渐失效。
    *   此外，由于误检的代价往往更大（需要更换芯片/重新计算），我们希望在0误检的前提下，最大化检测率。
*   **现状**：原版的A-ABFT方案：
    *   计算逻辑不适用于SIMD编程模型
    *   其给出的估计虽然显著优于传统的SEA-ABFT（1-2个数量级），但和真实的舍入误差仍然差了2-4个数量级,随矩阵大小增长。
    *   A-ABFT是基于向量内积操作给出的估计，这样做意味着误差将有检验码、求和码的误差分别构成，一方面增加了计算量，另一方面，这也是门限不够紧致的原因。

    基线方案（基于A-ABFT）虽简化了部分计算，但仍然有着过高的计算开销（$O(N^2)$ 级别但在小矩阵下显著），且由于简化不能通过多样化的数据测试。

### 1.2 设计目标
本设计旨在提出一种**基于统计方差估计的动态门限算法（Variance-Estimation based FT-GEMM）**，我们暂且称之为V-ABFT，达成以下指标：
1.  **高准确性**：在 FP8/BF16 低精度下，通过分块（Blocking）、方差估计和置信区间精确拟合舍入误差上界。
2.  **低开销**：将校验算力开销控制在 GEMM 计算流水的掩蔽范围内，理论额外 FLOPs 显著低于 A-ABFT。
3.  **流水线亲和**：优化 AIV（向量单元）与 AIC（矩阵单元）的异构协作。

---

## 2. 理论基础与误差模型 (Theoretical Framework)

### 2.1 方差估计

#### 2.1.1 极值理论

为了避免全量计算方差带来的高昂开销，本设计采用**极值理论（Extreme Value Theory）**，通过行/列的最大值来反推数据分布的方差。

假设矩阵元素 $x$ 服从独立同分布（i.i.d），均值为 $\mu$，方差为 $\sigma^2$。对于长度为 $n$ 的序列，其最大值 $m$ 近似满足：

$$ m \approx \mu + \sigma \sqrt{2 \ln n} $$

由此可得标准差 $\sigma$ 的**快速估计公式**：

$$ \sigma_{est} \approx \frac{m - \mu}{\sqrt{2 \ln n}} $$

> **工程意义**：通过 AIV 单元高效计算 `Max` 和 `Mean`，即可获得方差估计，无需计算昂贵的平方和。
> **缺陷**：强分布假设，无法适应llm训推中多样的矩阵分布，如被截断的矩阵等。

#### 2.1.2 上界估计法

已知序列$x_1, x_2, ..., x_n$的最大值$m$，最小值$l$，均值$\mu$，则其方差$\sigma^2$满足：

$$ \sigma^2 \leq (m - \mu)(\mu - l) $$

等号在序列只取最大/最小时取得，因此我们可以通过三个量快速给出方差的上界。

> **优势**：不依赖数据分布，更加鲁棒。
> **缺陷**：对正态分布的数据方差有一定的高估，从而会增加二类错误。


### 2.2 浮点运算的“黑盒”累加模型

我们的出发点是严格的浮点数误差分析方法。

定义单位舍入误差（Unit Roundoff）为 $u$：
*   **FP32**: $u = 2^{-24} \approx 5.96 \times 10^{-8}$
*   **BF16**: $u = 2^{-8} \approx 3.90 \times 10^{-3}$
*   **FP8 (E4M3)**: $u = 2^{-4} = 6.25 \times 10^{-2}$
*   **FP8 (E5M2)**: $u = 2^{-3} = 1.25 \times 10^{-1}$

基本运算模型满足：

$$ fl(x \cdot y) = (x \cdot y)(1 + \delta u), \quad |\delta| \le 1$$

$$ fl(x + y) = (x + y)(1 + \delta u), \quad |\delta| \le 1 $$

在混合精度硬件（如 Tensor Core / Cube Unit）上，矩阵乘法的累加顺序往往由硬件微架构决定（例如分块累加、树状归约），且中间可能涉及精度转换（FP16 $\to$ FP32 $\to$ FP16、AIC内高精度）。因此，我们将浮点运算视为一个具备有界误差的“黑盒”。
对于一个长度为 $K$ 的累加序列，考虑到硬件流水线的深度和累加顺序的不确定性，我们将累积的舍入误差建模为 $\prod_{i=1}^s(1+\delta_i u)$，其中 $s$ 为等效累加深度。为书写简便，我们忽略 $\delta$ 的下标，将其视为一个在 $[-1, 1]$ 间波动的随机变量,并把误差写为$(1+\delta u)^s$。用$fl(...)$表示括号中一系列运算最终得到的实际浮点数结果。

### 2.3 校验误差的代数表达

ABFT 的核心逻辑是比较“计算结果的行和”与“输入矩阵预计算行和后的乘积”。
对输入矩阵$A \in R^{M \times K}, B \in R^{K \times N}$,定义校验误差 $E$ 为检验差的绝对值：

$$
E = \left| fl\left( \sum_n fl \left(\sum_k A_{mk} B_{kn} \right) \right) - fl\left( \sum_k A_{mk} fl\left( \sum_n B_{kn} \right) \right) \right|
$$

利用上述浮点模型展开，误差来源于两条计算路径累加深度 $s_1$（先乘后加再求和）与 $s_2$（先求和再乘）的差异：

$$
\begin{align*}
E &= \left| \sum_n \sum_k A_{mk} B_{kn} (1+\delta u)^{s_1} - \sum_n \sum_k A_{mk} B_{kn} (1+\delta u)^{s_2} \right| \\
  &= \left| \sum_n \sum_k A_{mk} B_{kn} \cdot \underbrace{((1+\delta u)^{s_1} - (1+\delta u)^{s_2})}_{\text{Effective Error Factor } e_{kn}} \right| \\
  &:= \left| \sum_n \sum_k e_{kn} A_{mk} B_{kn} \right|
\end{align*}
$$

> **注**：$e_k$ 代表了由路径差异和机器精度共同决定的**综合误差系数**。

### 2.4 基于方差的统计展开

直接使用三角不等式（$|a+b| \le |a|+|b|$）会导致门限过于宽松（Worst-case Bound），在低精度下无法检测微小错误。因此，我们引入统计模型。

假设 $A, B$ 的元素服从独立分布，利用均值 $\mu$ 和方差 $\sigma$ 进行标准化分解：

$$ A_{mk} = \mu_{Am} + \sigma_{Am} \cdot a_{mk}, \quad a_{mk} \sim F_a $$

$$ B_{kn} = \mu_{Bk} + \sigma_{Bk} \cdot b_{kn}, \quad b_{kn} \sim F_b $$

>注：这里$F_a,F_b$是两个方差为1的分布，不一定是单位正态
根据您更新的变量定义（$A$ 使用行统计量 $\mu_{Am}$，$B$ 使用行统计量 $\mu_{Bk}$），推导过程中的下标和求和逻辑需要进行严格的同步更新。

将 $E$ 展开：
$$
\begin{align*}
E &= \left| \sum_n \sum_k e_{kn} (\mu_{Am} + \sigma_{Am} a_{mk})(\mu_{Bk} + \sigma_{Bk} b_{kn}) \right| \\
  &= \left| \sum_k (\mu_{Am} + \sigma_{Am} a_{mk}) \underbrace{\left(e_{kn} \sum_n (\mu_{Bk} + \sigma_{Bk} b_{kn}) \right)}_{\text{Sum over } N \text{ columns (Row } k \text{ of B)}} \right|
\end{align*}
$$

根据中心极限定理（CLT），对 $B$ 的 $N$ 列求和。注意此处 $\mu_{Bk}$ 和 $\sigma_{Bk}$ 是 $B$ 第 $k$ 行的统计量，因此在对 $n$ 求和时视为常数,记$\alpha_k=\frac{\sum_n e_{kn}}{N}$,$\beta_k=\sqrt{\frac{\sum_n e_{kn}^2}{N}}$则有：

$$ \sum_n e_{kn} \mu_{Bk} = N \alpha_k \mu_{Bk} $$

$$ \sum_n e_{kn} \sigma_{Bk} b_{kn}  = \sqrt{N} \sigma_{Bk} \beta_k b'_{k} $$

其中 $b'_k \sim F_b'$ 是代表 $B$ 第 $k$ 行随机波动的单位（方差）变量。

代入上式，误差 $E$ 变为对 $K$ 维度的累加：

$$
E = \left| \sum_k^K \left[ (\mu_{Am} + \sigma_{Am} a_{mk}) \cdot (N \alpha_k \mu_{Bk} + \sqrt{N} \sigma_{Bk}\beta_k b'_{k}) \right] \right|
$$

展开括号内的四项乘积（注意 $\mu_{Am}, \sigma_{Am}$ 均不随 $k$ 变化，可提取至求和符号外）：

$$
\begin{align*}
E = \Bigg| \bigg( & \underbrace{N \mu_{Am} \sum_k \alpha_k \mu_{Bk}}_{\text{(1) Bias Term}} + \underbrace{\sqrt{N} \mu_{Am} \sum_k \sigma_{Bk} \beta_k b'_k}_{\text{(2) Random B Term}} \\
& + \underbrace{N \sigma_{Am} \sum_k \alpha_k\mu_{Bk} a_{mk}}_{\text{(3) Random A Term}} + \underbrace{\sqrt{N} \sigma_{Am} \sum_k \sigma_{Bk} \beta_k a_{mk} b'_k}_{\text{(4) Interaction Term}} \bigg) \Bigg|
\end{align*}
$$

#### 物理意义解读

1.  **项 ① (Bias Term)**: $N \mu_{Am} (\sum \mu_{Bk})$。这是主要的直流分量，由 $A$ 的行均值和 $B$ 的列和均值决定。
2.  **项 ② (Random B)**: $\sqrt{N} \mu_{Am} \sqrt{K} \dots$。由 $B$ 矩阵的行内波动引起，随 $\sqrt{K}$ 增长。
3.  **项 ③ (Random A)**: $N \sigma_{Am} \sqrt{K} \dots$。由 $A$ 矩阵的行内波动引起，随 $\sqrt{K}$ 增长。
4.  **项 ④ (Interaction)**: $\sqrt{N} \sigma_{Am} \sqrt{K} \dots$，在A、B都是0均值时占据主导，随 $\sqrt{K}$ 增长。

然后利用三角不等式，

$$
\begin{align*}
E \leq \underbrace{\left| \sum_k \alpha_k N \mu_{Am} \mu_{Bk} \right|}_{\text{Bias Term (DC)}} + \underbrace{\left| \sum_k \beta_k \sqrt{N} \mu_{Am} \sigma_{Bk} b'_{k}  +  \sum_k \alpha_k N \sigma_{Am} a_{mk} \mu_{Bk} \right|}_{\text{Linear Random Term (Primary Noise)}} + \underbrace{\left| \sum_k \beta_k \sqrt{N} \sigma_{Am} a_{mk} \sigma_{Bk} b'_{k} \right|}_{\text{Interaction Term (Secondary Noise)}}
\end{align*}
$$

为了得到工程可用的门限，我们引入一致上界 $e_{max} \ge max\{|\alpha_k|, |\beta_k|\}$，将其提取至外部：
对于随机项，利用独立随机变量和的方差性质（$Var(\sum X_i) = \sum Var(X_i)$），并取 $4\sigma$（对正态分布约 99.9% 置信度）作为安全边界：

$$
\begin{align*}
Bound &\lesssim e_{max} \left( \underbrace{N|\mu_{Am}| \sum_k |\mu_{Bk}|}_{\text{Deterministic Bound}} + 4\sqrt{\underbrace{N \sum_k \mu_{Am}^2 \sigma_{Bk}^2}_{\text{Var of Term 2}} + \underbrace{N^2 \sigma_{Am}^2 \sum_k \mu_{Bk}^2}_{\text{Var of Term 3}}} + 4\underbrace{\sqrt{N}\sigma_{Am} \sqrt{\sum_k \sigma_{Bk}^2}}_{\text{SD of Term 4}} \right)
\end{align*}
$$

>注：2、3项往往是独立的变量，因此我们将它们合并处理，而第4项与2、3项有一定的耦合，因此单独放缩。另外，在a、b独立时$A_{mk} b'_{k}$方差为1，但如果它们正相关，那么方差>1,此时可能要取更大的系数来控制。

## 3 最终工程门限公式

通过上述统计推导，误差上界不再是线性累加，而是服从方差合成规律。我们将误差界 $T_{bound}$ 分解为两部分：**均值漂移项（DC Component）** 和 **随机波动项（AC Component）**。

$$
T_{bound} \approx e_{max} \cdot \left( \underbrace{K \cdot N \cdot |\mu_A \mu_B|}_{\text{Bias Term}} + \underbrace{\sqrt{K} \cdot \Phi(\mu, \sigma, N)}_{\text{Variance Term}} \right)
$$

在工程实现中，为了避免复杂的 $\Phi$ 函数计算，我们利用 2.1 节提到的极值理论，将 $\sigma$ 替换为 $(Max - Mean)/\sqrt{2ln(n)}$ 的形式，或利用上界估计，将 $\sigma$ 替换为 $\sqrt{(Max - Mean)(Mean - Min)}$ 的形式。对于$e_{max}$,我们目前先采用$3u$的形式。后续可以针对硬件做经验性测试。
得到最终的**可计算门限**：

$$
\text{Threshold} = 3u \left( \underbrace{n|\mu_{Am}| \sum_k |\mu_{Bk}|}_{\text{Deterministic Bound}} + 4\sqrt{\underbrace{N \sum_k \mu_{Am}^2 \sigma_{Bk}^2}_{\text{Var of Term 2}} + \underbrace{N^2 \sigma_{Am}^2 \sum_k \mu_{Bk}^2}_{\text{Var of Term 3}}} + 4\underbrace{\sqrt{N}\sigma_{Am} \sqrt{\sum_k \sigma_{Bk}^2}}_{\text{SD of Term 4}} \right)
$$

> 注：目前对于$e_{max}$的粗略估计方法：生成分布服从$N(1,1)$的矩阵A,B，在机器精度下计算检验码和C矩阵行和的相对误差，反复进行100k次实验，取最大值作为$e_{max}$。可以针对不同硬件进行更精细的经验性测试。在910B芯片上，BF16、FP32、FP16下的实验值约为7.76e-03，2.13e-06，9.77e-04,$e_{max}$分别取成8e-03，2.2e-06，1e-03。
> 实验中发现，FP32下$e_{max}$估计值随矩阵规模增长，低精度下$e_{max}$与矩阵规模关系不大，可能与硬件的累加单元设计有关。
> 比起A-ABFT原版实现，我们在FP32下的门限仅仅比误差高出一个数量级（～20x），且不随矩阵大小增长。

### 3.1 采样法加速

目前均值、方差估计的计算占门限开销较大比重，为加速计算，我们在容许一定误检的情况下进行采样计算，并在检出错误之后进行二次确认。这样可以减少门限的额外计算开销。

具体而言，我们可以跨stride列进行采样计算均值和方差。例如，对于矩阵 $A$ 的行均值 $\mu_{Am}$，我们可以只用下标$ i\text{ mod } 32 < 16 $的数据计算均值和方差。

但是采样比例对A、B矩阵统计量估计的影响是异质的，A矩阵分块行长度为$K=1024$，B矩阵分块行长度为$N=256$，直观上讲，如果采取同样的采样比例，A、B的统计量置信度差异较大。因此，我们采用不同的采样比例来平衡A、B矩阵统计量的置信度，或者只采样A矩阵。同时为减少触发误检，我们可以一定比例的提升门限。

## 4.对基线方案：A-ABFT的讨论

基线方案是基于**混合精度浮点误差分析**（Mixed Precision Floating-point Error Analysis）构建的。

它主要模拟了这样一个场景：我们用 **FP32**（高精度）去校验一个 **BF16**（低精度）矩阵乘法的结果，并计算理论上允许的最大误差。

我们定义以下符号：

*   $A, B$: 输入矩阵。$A \in \mathbb{R}^{M \times K}, B \in \mathbb{R}^{K \times N}$。
*   $C$: 计算结果矩阵，$C = A \times B$。
*   $N$: 矩阵 $B$ 的列数。
*   $K$: 矩阵乘法的内维。
*   $\epsilon_{high} = 2^{-23}$: FP32 的机器精度。
*   $\epsilon_{low} = 2^{-8}$: BF16 的机器精度。

函数返回的总误差界限 $E_{total}$ 由四部分组成：

$$ E_{total} = E_{\text{sum\_C}} + E_{\text{ele\_round}} + E_{check_1} + E_{check_2} $$

下面是每一项的数学公式及其物理含义：

#### $E_{\text{sum\_C}}$ : C 的求和累积误差

**数学公式：**

$$ E_{\text{sum\_C}} = \left( \sqrt{\frac{1}{8} \sum_{i=1}^{N} i^2} \right) \cdot \max(|C|) \cdot \epsilon_{high} $$


#### $E_{\text{ele\_round}}$ : C 的元素量化误差累积

**数学公式：**

$$ E_{\text{ele\_round}} = \epsilon_{low}\sqrt{N}\max(|C|) $$

*   **解释**：
    *   $\max(|C|)$表示对矩阵C每行元素绝对值取最大值得到的向量。
    *   $\sqrt{N}$ 代表 $N$ 个独立随机误差相加后的标准差增长。
    *   这是**占比最大**的一项，因为它涉及低精度 $\epsilon_{low}$。

#### $E_{check_1}$ : A和Be的乘法误差和累加

**数学公式：**

$$ \delta_1 = \epsilon_{high} \left( \sqrt{\frac{1}{8} \sum_{i=1}^{N} i^2 } \right) \max(|B|) $$

$$ E_{\text{prop}} = |A| \times \delta_1 $$

*   **解释**：
    *   $\max(|B|)$ 表示对矩阵B每行元素绝对值取最大值得到的向量。$|A|$ 表示对A矩阵每个元素取绝对值得到的矩阵。
    *   $\delta_1$ 是计算 $B$ 的行和时的累积误差（结构同第一项）。

#### $E_{check_2}$ : A作用在Be误差上的二次误差

**数学公式：**

$$ E_{\text{matmul\_diff}} \approx \epsilon_{high}\left( \sqrt{\frac{1}{8} \sum_{k=1}^{K} k^2+\frac{K}{12}} \right)  \max(\max(|B|))\max(|A|) $$

*   **解释**：
    *   $\max(\max(|B|)) $表示对矩阵B所有元素绝对值取最大值的标量。$\max(|A|)$ 表示对矩阵A每行元素绝对值取最大值得到的向量。
    *   它反映了在进行 $K$ 次乘加运算时，FP32 精度下的舍入噪声。

该方案的主要局限性：

1.  **对校验精度的强依赖**：假设使用高精度（FP32）进行校验，在实际硬件中这需要牺牲性能。此时第2项主导误差界。但是第2部分为简化运算，并非严格按照A-ABFT的推导进行，因此不准确。
2.  **误差模型的保守性**：对求和操作采用最坏情况分析，忽略了统计分布特性，导致1、3、4部分门限过宽松，难以检测微小错误。实际上，如果使用FP16进行校验，1、3、4部分的误差将主导误差界，此时检出率为0。
3.  **对A*B计算误差的忽视**：没有考虑低精度矩阵乘法本身的舍入误差对校验结果的影响，导致误差界估计不足。
4.  **A-ABFT本身隐含的假设**： A-ABFT作者推导过程中隐含了这样一个假设：所以即使过程中的数据的指数部分尾数部分是独立的。我对此持怀疑态度，比如一个[0.9,1.1]区间内均匀分布的数据，如果指数部分是1，那么尾数部分是[1.0,1.1]，如果指数部分是0.5，那么尾数部分是[1.8, 2)。作者没有讨论这种相关性是否会影响最终的误差分布。

更多细节请看实验部分。

## 5. 实验：检出率&误检率

不同精度下的误检率（目前无法测量FP8），检出率，对V-ABFT，对BF16、FP32、FP16，我们分别将$e_{max}$设为8e-03，2.2e-06，1e-03, 方差项系数取成2.5。

我们主要关注指数位发生的错误，因为尾数位bit翻转引起的误差较小(单元素数值影响<33.4%)，此外，大模型中有大量的norm/softmax等操作会抑制小数值误差的影响。同理，指数位从1->0的翻转会导致数值变小，这种错误对数值影响同样较小（<100%），且不是ABFT算法的主要关注点，因此我们主要关注0->1的翻转。但考虑到实验的完整性，我们也测量了1->0翻转的检出率。

### 5.1 模拟数据

我们生成了多组模拟数据，矩阵$A$和$B$的元素分别服从以下分布：

1.  正态分布 $N(1e-6,1)$
2.  正态分布 $N(1,1)$
3.  均匀分布 $U(-1,1)$
4.  截断正态分布 $N(0,1)$ 截断在 $[-1,1]$ 范围内


情形1和4将是最常见情形，情形2和3用于测试算法的鲁棒性。两种算法都在$(M,K,N) = (128, 1024, 256)$的矩阵规模下测试（适配昇腾芯片），BF16精度下在第7-15位插入单比特0->1翻转的软错误。

> BF16 格式: [符号(1) | 指数(8) | 尾数(7)]
> FP32 格式: [符号(1) | 指数(8) | 尾数(23)]
> FP16 格式: [符号(1) | 指数(5) | 尾数(10)]
> 尾数位最后一位为第0位，指数位第一位为第7位。
> 注1：我们不关注1->0翻转，因为它会导致数值变小，这种错误对模型训练的影响较小，且不是ABFT算法的主要关注点。
> 注2：第7位bit位翻转等效于该数字乘以$2^{2^0}=2$,第8位bit位翻转等效于该数字乘以$2^{2^1}=4$，接下来是16，256，...。增长是双重指数级的。

#### 5.1.1 误检率


| 算法 | 正态分布 $N(10^{-6},1)$ | 正态分布 $N(1,1)$ | 均匀分布 $U(-1,1)$ | 截断正态分布 $N(0,1)$ |
|------|------------------------|------------------|-------------------|----------------------|
| **V-ABFT（BF16）（%）** | 0.0000 | 0.0000 | 0.0000 | 0.0000 |
| **V-ABFT（FP32）（%）** | 0.0000 | 0.0000 | 0.0000 | 0.0000 |
| **V-ABFT（FP16）（%）** | 0.0000 | 0.0000 | 0.0000 | 0.0000 |
| **A-ABFT（%）** | 0.0000 | 84.8250 | 0.0000 | 0.0000 |

实验规模：100k次
> 注1：A-ABFT混合精度校验方案只能用于检测低精度矩阵乘法结果，因此只测试了BF16精度下的误检率。
> 注2：V-ABFT在所有分布下均实现了零误检率，而A-ABFT在高均值正态分布下表现不佳，误检率高达84.825%。原因在于对A*B计算误差的忽视。太过于依赖最终C矩阵的结果，但是C矩阵的误差本身就很大，导致校验失效。

#### 5.1.2 检出率

对检出率，我们对每一位bit位翻转都进行了测试，结果如下表所示：

V-ABFT（BF16）（%）

| 比特位 | 正态分布 $N(10^{-6},1)$ | 正态分布 $N(1,1)$ | 均匀分布 $U(-1,1)$ | 截断正态分布 $N(0,1)$ |
|------|------------------------|------------------|-------------------|----------------------|
| **7th** | 0.0064 | 0.0000 | 19.6558 | 10.8967 |
| **8th** | 36.6953 | 69.5500 | 46.8472 | 36.4867 |
| **9th** | 73.4750 | 100.0000 |  75.0310 | 99.3833 |
| **10th** | 99.9860 | -       | 99.8603 | 99.9567 |
| **11th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **12th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **13th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **14th** | 100.0000 | -        | 100.0000 | 100.0000 |
| **15th** | 4.4033 | 5.5100 | 42.3433 | 56.7233 |

V-ABFT（FP32）（%）

| 比特位 | 正态分布 $N(10^{-6},1)$ | 正态分布 $N(1,1)$ | 均匀分布 $U(-1,1)$ | 截断正态分布 $N(0,1)$ |
|------|------------------------|------------------|-------------------|----------------------|
| **23th** | 99.9367 | 100.0000 | 99.9633 | 99.9800 |
| **24th** | 99.9833 | 100.0000 | 99.9767 | 99.9867 |
| **25th** | 99.9967 | 100.0000 |  100.0000 | 99.9967 |
| **26th** | 99.9967 | 100.0000 | 100.0000 | 100.0000 |
| **27th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **28th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **29th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **30th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **31th** | 99.9667 | 100.0000 | 99.9833 | 99.9967 |

V-ABFT（FP16）（%）

| 比特位 | 正态分布 $N(10^{-6},1)*10^{-2}$ | 正态分布 $N(1,1)*10^{-2}$ | 均匀分布 $U(-1,1)*10^{-2}$ | 截断正态分布 $N(0,1)*10^{-2}$ |
|------|------------------------|------------------|-------------------|----------------------|
| **10th** | 67.0467 | -    | 77.2533 | - |
| **11th** | 88.6567 | -    | 92.2367 | - |
| **12th** | 80.4893 | 100.0000 |  100.0000 | 100.0000 |
| **13th** | 100.0000 | -    | 100.0000 | - |
| **14th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **15th** | 80.1267 | 100.0000 | 92.2933 | 100.0000 |

A-ABFT(BF16)（%）

| 比特位 | 正态分布 $N(10^{-6},1)$ | 正态分布 $N(1,1)$ | 均匀分布 $U(-1,1)$ | 截断正态分布 $N(0,1)$ |
|------|------------------------|------------------|-------------------|----------------------|
| **7th** | 87.1876 | * | 87.0669 | 80.1737 |
| **8th** | 96.9240 | * | 96.9887 | 94.5370 |
| **9th** | 99.5554 | * |  99.5269 | 99.2126 |
| **10th** | 99.9790 | * | 99.9930 | 100.0000 |
| **11th** | 100.0000 | * | 100.0000 | 100.0000 |
| **12th** | 100.0000 | * | 100.0000 | 100.0000 |
| **13th** | 100.0000 | * | 100.0000 | 100.0000 |
| **14th** | 53.9394 | * | 48.6708 | 55.6291 |
| **15th** | 93.1479 | * | 92.0962 | 91.1012 |

> 注1：带有-的单元格表示无法注入该类型翻转, *表示该列误检率过高，检出率无意义。
> 注2: FP16数据大小乘1e-2是由于FP16可表示数值范围有限，导致矩阵乘法结果溢出为无穷大。

实验规模：>10k次(每个位)

可以看出，BF16下V-ABFT在能比较稳定的检出前5位bit位翻转错误，大概率检出第6位错误。A-ABFT能高概率检测出所以错误，但是代价是
**1**.需要高精度的校验（无法改为低精度）；
**2**.在高均值分布下误检率过高，导致检出率无意义。

而实际生产环境中，矩阵乘法的输入矩阵可能是多种分布的混合，V-ABFT的鲁棒性更强。

#### 5.1.3 1->0翻转检出率

1->0翻转结果如下表所示：

V-ABFT（BF16）（%）

| 比特位 | 正态分布 $N(10^{-6},1)$ | 正态分布 $N(1,1)$ | 均匀分布 $U(-1,1)$ | 截断正态分布 $N(0,1)$ |
|------|------------------------|------------------|-------------------|----------------------|
| **7th** | 0.0000 | 0.0000 | 0.0000 | 0.0400 |
| **8th** | 36.6953 | -     | 5.5800 | 11.0600 |
| **9th** | 0.0000 | -      |  2.0023 | 36.8740 |
| **10th** | 0.0000 | 0.0000 | 0.0000 | 0.0000 |
| **11th** | 0.0000 | -      | 0.0000 | 0.0000 |
| **12th** | 0.0000 | -      | 0.0000 | 0.0000 |
| **13th** | 0.0000 | -      | 0.0000 | 0.0000 |
| **14th** | 0.0000 | 0.0000 | 13.3900 | 28.6900 |
| **15th** | 4.4900 | -      | 42.3400 | 56.9300 |

V-ABFT（FP32）（%）

| 比特位 | 正态分布 $N(10^{-6},1)$ | 正态分布 $N(1,1)$ | 均匀分布 $U(-1,1)$ | 截断正态分布 $N(0,1)$ |
|------|------------------------|------------------|-------------------|----------------------|
| **23th** | 99.8700 | 100.0000 | 99.9500 | 99.9600 |
| **24th** | 99.8900 | - | 100.0000 | 99.9600 |
| **25th** | 99.9600 | - |  99.7343 | 99.8176 |
| **26th** | 99.0605 | 100.0000 | 100.0000 | 100.0000 |
| **27th** | 98.1978 | - | 99.7464 | 99.8748 |
| **28th** | 98.3240 | - | 99.7839 | 99.6716 |
| **29th** | 98.1148 | - | 99.7841 | 99.8750 |
| **30th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **31th** | 99.9600 | - | 99.9900 | 99.9900 |

V-ABFT（FP16）（%）

| 比特位 | 正态分布 $N(10^{-6},1)$ | 正态分布 $N(1,1)$ | 均匀分布 $U(-1,1)$ | 截断正态分布 $N(0,1)$ |
|------|------------------------|------------------|-------------------|----------------------|
| **10th** | 42.3333 | 99.5800  | 66.3667 | 100.0000 |
| **11th** | 77.7667 | 100.0000 | 64.9667 | 100.0000 |
| **12th** | 67.7333 | -        | 100.0000| -     |
| **13th** | 100.0000| 100.0000 |  -      | 100.0000 |
| **14th** | -       | -        | -       | -     |
| **15th** | 79.7333 | -        | 92.5667 | -     |

> 注：带有-的单元格表示无法注入该类型翻转。

实验规模：>10k次(每个位)

#### 5.1.4 更多规模下的表现

独立的门限测试算法（和GEMM算子解耦）无法做到切分K维度，而典型的矩阵维度是4096*4096，因此我们分别在(128,4096,256),(4096,4096,4096)下测试了误检率（皆为0）和检出率（BF16）。

V-ABFT检出率（%）(128,4096,256)

| 比特位 | 正态分布 $N(10^{-6},1)$ | 正态分布 $N(1,1)$ | 均匀分布 $U(-1,1)$ | 截断正态分布 $N(0,1)$ |
|------|------------------------|------------------|-------------------|----------------------|
| **7th** | 0.0000 | 0.0000 | 9.5776 | 36.7597 |
| **8th** | 13.0348 | 92.5000 | 82.1467 | 69.3462 |
| **9th** | 39.8570 | 100.0000 |  81.8534 | 97.4612 |
| **10th** | 99.9846 | 100.0000 | 99.9949 | 99.9860 |
| **11th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **12th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **13th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **14th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |

V-ABFT检出率（%）(4096,4096,4096)

| 比特位 | 正态分布 $N(10^{-6},1)$ | 正态分布 $N(1,1)$ | 均匀分布 $U(-1,1)$ | 截断正态分布 $N(0,1)$ |
|------|------------------------|------------------|-------------------|----------------------|
| **7th** | 0.0000 | 0.0000 | 0.0000 | 0.0000 |
| **8th** | 0.0000 | -      | 0.0000 | 26.4159 |
| **9th** | 0.0000 | 0.0000 |  3.4595 | 67.5388 |
| **10th** | 96.4110 | -       | 99.9383 | 100.0000 |
| **11th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **12th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **13th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |
| **14th** | 100.0000 | 100.0000 | 100.0000 | 100.0000 |

实验规模：>5k次(每个位)

### 5.2 实际模型数据

我们还在实际大模型训推中收集了矩阵数据，进行了误检率测试。
实验模型分别有llama-7b，gpt2，ViT-B/32。V-ABFT在所有测试中均实现了0误检率。

数据规模：

##### Llama-7B

所有A-ABFT误检矩阵（111个）使用V-ABFT重新测试，均为0误检率。

##### gpt2

5379个矩阵乘法校验，均为0误检率。

##### ViT-B/32

进行微调任务，50epochs，抽样了1%的矩阵乘法，共计5937个矩阵乘法校验。
